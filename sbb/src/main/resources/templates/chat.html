<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>Moata - 실시간 채팅</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SockJS & STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">

    <!-- 배경 장식 -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-400/20 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-400/20 rounded-full blur-3xl"></div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">실시간 채팅</h1>
            <p class="text-gray-600 mt-1">매칭된 택시 메이트들과 소통하세요</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">

            <!-- 좌측: 채팅방 목록 -->
            <div class="backdrop-blur-sm bg-white/80 border rounded-lg shadow-xl">
                <div class="p-4 border-b">
                    <h2 class="font-semibold">채팅방 목록</h2>
                </div>
                <div class="p-4 space-y-2">
                    <div class="p-4 rounded-lg bg-blue-100 border-2 border-blue-200 cursor-pointer">
                        <h3 class="font-semibold text-sm" th:text="${targetUser}">username</h3>
                    </div>
                </div>
            </div>

            <!-- 우측: 채팅창 -->
            <div class="lg:col-span-2 backdrop-blur-sm bg-white/80 border rounded-lg shadow-xl flex flex-col">

                <!-- 채팅방 헤더 -->
                <div class="p-4 border-b">
                    <h2 class="font-semibold text-gray-900" th:text="${targetUser}">username</h2>
                </div>

                <!-- 메시지 영역 -->
                <div id="messageArea" class="flex-1 p-4 overflow-y-auto space-y-4">

                    <!-- 처음 안내 메시지 -->
                    <div class="flex justify-center">
                        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                            상대방과 매칭되었습니다!
                        </div>
                    </div>

                </div>

                <!-- 입력창 -->
                <div class="border-t p-4">
                    <form id="messageForm" class="flex gap-2">
                        <input id="messageInput" type="text" placeholder="메시지를 입력하세요..." 
                               class="flex-1 px-3 py-2 border rounded-lg">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">전송</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- 채팅 WebSocket 로직 -->
	<script th:inline="javascript">
	    const username = /*[[${username}]]*/ 'Guest';         // 로그인한 사용자
	    const targetUser = /*[[${targetUsername}]]*/ 'Unknown'; // 상대
	</script>

	<script>
	    let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, () => {
                console.log("WebSocket 연결됨!");

                stompClient.subscribe('/topic/messages', (message) => {
                    const msg = JSON.parse(message.body);
                    showMessage(msg);
                });
            });
        }

        function showMessage(msg) {
            const area = document.getElementById("messageArea");

            // 오른쪽/왼쪽 정렬 판단
            const isMine = msg.from === username;

            const bubble = document.createElement("div");
            bubble.className = `flex gap-3 ${isMine ? "flex-row-reverse" : ""}`;

            bubble.innerHTML = `
                <div class="w-8 h-8 ${isMine ? "bg-green-500" : "bg-blue-500"} rounded-full"></div>
                <div class="flex flex-col ${isMine ? "items-end" : ""}">
                    <div class="bg-${isMine ? "blue-600 text-white" : "gray-100 text-gray-900"} px-4 py-2 rounded-2xl">
                        <p class="text-sm"><strong>${msg.from}</strong>: ${msg.content}</p>
                    </div>
                </div>
            `;

            area.appendChild(bubble);
            area.scrollTop = area.scrollHeight;
        }

        document.getElementById("messageForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const input = document.getElementById("messageInput");
            const text = input.value.trim();

            if (!text) return;

            const msg = {
                sender: username,
                content: text
            };

            stompClient.send("/app/chat", {}, JSON.stringify(msg));
            input.value = "";
        });

        connect();
    </script>

</body>
</th:block>
</html>
